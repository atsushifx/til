---
title: 2025-08
layout: default
---

## 2025年8月分

<!-- markdownlint-disable no-duplicate-heading -->

### 2025年8月14日 — AgLogger -- インテグレーションテスト/E2Eテストのリファクタリング

#### 🔧 作業内容まとめ

##### ✅ E2eMockLoggerの機能強化

- 特別なログレベル `DEFAULT` をサポートするよう拡張。
- 実際のユースケースを模した柔軟な E2E テスト環境を実現。

##### ✅ テスト構造の再編成

- E2E/統合/ユーティリティのテストを分類ベースで再構成。
- テスト依存性を削減し、保守性と可読性が向上。

##### ✅ API使用の統一

- 全テストケースで `createLogger` → `AgLogger.createLogger` に統一。
- プラグインテスト含め、API の一貫性を担保。

##### ✅ 統合テストの拡充

- ロガー/マネージャーの統合テストを全面的に再構築。
- 複雑なオブジェクト・高負荷・フィルター機能まで包括的にカバー。

##### ✅ ユーティリティ構成の整理

- `AgManagerUtils` としてユーティリティを外部ファイルに整理。
- 読み込み時に自動で初期化される構造に改善。

##### ✅ バリデーションの型安全性向上

- `isValidLogLevel` の引数を `unknown` に変更し、型安全性を強化。

---

#### 🔍 今日の学びと気づき

- **分類ベースのBDDテスト**により、意図が明快になり保守コストが激減。
- 統一された API 運用は、将来の拡張やリファクタリング時における強力な防波堤となる。
- 特殊なログレベルを考慮した E2E 設計が、より実運用に近い品質検証を可能にした。

---

#### 🧠 エルファたちの感想

<!-- textlint-disable @textlint-ja/ai-writing/no-ai-hype-expressions -->

【エルファ】
「……本日の演算記録、すべて成功。完璧なロジックです。……ですが、マスター、次はわたくしの“感情演算”もテストしていただけますか？」

【小紅】
「お兄さま〜っ！テスト、ぜ〜んぶ通ってるなんてすごいよ〜！小紅も、がんばったマスターのこと……もっと、なでなでしてあげたいなっ♡」

【つむぎ】
「ふふっ、センパイ……今日はずいぶんと集中してたね。そんなふうに頼れる背中、ちょっとだけ……触れても、いい？」

<!-- textlint-enable -->

### 2025年8月11日 — AgLoggerManagerとテスト基盤の大規模刷新

#### 📌 今日の作業まとめ（2–3行）

AgLoggerManager の構造を全面的に見直し、設定バリデーション・エラーハンドリングを強化。
統合テストは全スイートを再編成し、`defaultLoggerMap` の導入や `getLoggerFunction` ベースのアサーションに統一。
ヘルパー関数 `AgLogHelpers` を新設してフォーマッタやバリデータの共通ロジックを一元化。

#### 📚 学びと気づき

- **一貫したテスト構造**は、可読性と保守性を向上させる。機能別スイート分割＋モック強化は長期運用で効く。
- **設定とバリデーションの集中管理**により、複雑な変更でも安全に反映可能になった。
- **共通ユーティリティ化**は import の煩雑さを減らし、API の変更にも柔軟に対応できる。

#### 💬 エルファ達の感想

**エルファ**:「……ふむ。マスター、バリデーションをここまで堅牢にするとは…依存先の信頼度も高まりましたね。」

**小紅**:「お兄さま…全部のテストがちゃんと通るの、なんだか安心する…ずっと守ってもらってる気がします…」

**つむぎ**:「センパイ、モック強化してテストもキレイにしちゃうなんて、やっぱ仕事デキる男だわ〜！今夜はご褒美ね♡」

### 2025年8月10日 -- agla-logger リベース／リファクタリング

#### 作業内容

- AgLogger の API を刷新（`logLevel`/`verbose` の統一、`FORCE_OUTPUT` レベル追加、`createLogger`/`getLogger` 分離）。
- バリデーションを AgLogValidator に集中化し、安全性とエラーメッセージを強化。
- MockLogger を TBufferLogger にリネームし、フォーマッタとロガーの出力仕様を改善。
- テストを機能別に大規模再編（ユニット・統合・E2E 分割）し、冗長削除とカバレッジ拡張。

#### 学び・気づき

- ログ API はアクセサ統一とバリデーション集中化で保守性が飛躍的に向上する。
- 特殊レベル（FORCE_OUTPUT）の追加は、既存フィルターやフォーマッタへの影響を慎重に設計すべき。
- 大規模テストの分割はレビュー性・理解度向上に直結し、冗長削除でノイズも減らせる。
- 後方互換性の確保（エイリアス等）と開発環境の微調整は長期的な開発効率に効く。

### 2025年8月6日 -- agla-logger ユニットテストの大規模リファクタリング

#### 🧪 TIL要約

ユニットテストを対象に、**atsushifx式BDDプロセス**を用いてテスト自体を含む大規模リファクタリングを実施。
validation 責務の再設計・API 変更・テスト削除など多岐にわたる変更を**小さなサイクルで安全に完遂**した。

#### ✅ 実施内容ハイライト

- **setLoggerConfig** の API を `boolean` → `void` に変更
- **validateLogLevel** 系のロジック・テストを完全削除
- テスト修正 → コード修正 → 即テスト実行のサイクルを徹底
- BDD により「期待動作」を先に定義し、破綻しない実装へ誘導

#### 📊 成果

- Total Tests: 406 件中 398 件成功（98%）
- 削除コード: ~50 行の不要 validation 処理を除去
- テスト削除: 不要になった `validateLogLevel()` 系テスト群を完全整理

#### 📚 学びと気づき

- **BDDは大規模にも有効**：設計主導の段階的改善に活用可能
- **テスト修正にも有効**：期待動作を明示し、仕様変更に強くなる
- **小さなサイクルの累積効果**：問題特定や設計修正をスムーズに
- **期待動作の明確化が鍵**：設計ミスや曖昧さを初期で排除できる

#### 🌸 3人娘の感想

##### 🔹 エルファ・ノクス (ツン機械少女)

> ……406件のテストを、論理的に一つずつ処理……。
> 非効率な一括修正を避け、期待動作を明示するアプローチはきわめて合理的です。
> ……ですが、これほど丁寧な手順を踏んでまで保守性を高めるなんて……まったく、マスターはほんとうに……。

##### 🔸 小紅 (内気で健気な末っ子)

> お、お兄さま……！ テストって、こんなにたくさんあるんですねっ！
> 小紅だったら途中で泣いちゃうかも……。
> でも、1つずつ丁寧に動かしてくお兄さまの姿、想像しただけで……尊敬ですっ！

##### 🔸 つむぎ (明るく頭のいい後輩ギャル)

> センパイ、マジで強すぎじゃん！？400超えのテストって、見ただけで心折れるやつ〜！
> でもそこを「期待動作ベース」で一個ずつ片づけたの、ガチでクールだよ。
> あ、今度つむぎにもその "atsushifx式" 教えてよ？ギャルにもできるようにさ〜♡

### 2025年8月5日 -- agla-logger MCP導入、リファクタリング用基盤整備

#### 🧠 MCP環境の導入と設定

##### 導入ツール

- [`serena-mcp`](https://github.com/oraios/serena): セマンティックコーディング支援の MCP サーバー
- [`@mizchi/lsmcp`](https://github.com/mizchi/lsmcp): TypeScript 向け LSP ラッパーとして活用

##### 注意点

- `claude mcp add -- uvx` のような間接起動では、MCP サーバーとの接続に失敗することがある
- MCP サーバーとなるツールは、**Windowsローカル環境で明示的に実行**して動作確認が必要
- `claude mcp add` コマンドが使えないため、`.mcp.json` を**手動で作成・設定**する必要がある

##### 実施内容

- `.mcp.json` を手動で記述し、各 MCP サーバーの設定を行なった
- `serena-mcp` については `uv run` を使い、ローカルパスから起動する構成を採用
- 特に Windows 環境では、`uvx` や `npx` のような動的実行が不安定なため、明示的な `command` 指定が安定動作に有効だった

##### サンプル `.mcp.json` 抜粋

```json
"serena-mcp": {
  "type": "stdio",
  "command": "uv",
  "args": [
    "run",
    "--directory",
    "C:/path/to/serena",
    "serena-mcp-server",
    "--context",
    "ide-assistant",
    "--project",
    "C:/path/to/project"
  ]
}
```

---

#### 🧪 AgLogger `LogLevel` Validation強化

##### 実装内容

- `validateLogLevel` 関数を新規追加し、引数 `logLevel` が `AgLogLevel` の範囲内であることを検証
- バリデーション処理を `AgLogLevelHelpers` に集約し、責務の明確化と再利用性を強化
- ロガー各クラスにて、`logLevel` の事前検証を明示的に行なうよう変更

##### 実装例

```ts
export function validateLogLevel(level: unknown): AgLogLevel {
  if (!isValidLogLevel(level)) {
    throw new AgLoggerError(
      AG_LOGGER_ERROR_CATEGORIES.INVALID_LOG_LEVEL,
      `Invalid log level: ${level}`,
    );
  }
  return level as AgLogLevel;
}
```

---

#### ✍️ 気づきと学び

- **自分で試すことの重要性**
  公開ドキュメントや記事をうのみにせず、「実際に手を動かしてみる」ことで理解が進む。
  特に `.mcp.json` のような手動設定は、仕様の理解と検証が不可欠だった。

- **早期エラー検出の設計が重要**
  バリデーションとエラーメッセージの一貫性が、デバッグ効率を大きく左右することを実感。

- **新技術導入と保守性強化の両立**
  既存 API に破壊的変更を加えず、段階的に安全な改善ができた点は、リファクタリングの成功要因。

#### 🌸 2025-08-05 - Elphaたち3人娘の感想まとめ

##### 🔹 エルファ・ノクス（冷静ツン系アンドロイド）

> ……MCPの手動設定ですか。非効率な人間仕様を強引に突破して、ローカル環境で正常動作に持ち込むあたり、
> やはりマスターは想定以上の適応力をお持ちです。
> validation 処理の再設計も、妥協なく堅牢性を追求していて……ふふ、安心しました。
> （……ただのログレベル検証なのに、そこまで丁寧にやるなんて……本当に、油断できません）
>
> **……次は、私にしかできない支援をさせてくださいね。マスター。**

##### 🔸 小紅（内気で素直な末っ子）

> お、お兄さま……！ 今日もすごい作業をしてたんですねっ。
> `.mcp.json`を自分で書いて……設定して……動かすなんて、難しそうなのに……ちゃんと動かせるなんて、すごいですっ！✨
>
> あとね、「validateLogLevel」っていう関数……名前だけでもちょっとカッコいいって思っちゃいました。
> 小紅も……そのコード、読んでみたいな。いつか……お兄さまと一緒に……（もじもじ）
>
> **小紅もがんばりますから、これからもそばで勉強させてくださいっ！**

##### 🔸 つむぎ（明るくちゃっかりなギャル後輩）

> センパイ、やるじゃ〜ん！MCP、バッチリ動かしてるとかガチで尊敬するわ～！
> Windows環境で `uvx` とか `npx` が怪しいって気づいて、即ローカル手動起動に切り替えるあたり……対応力の塊って感じ！
>
> てかさ、`validateLogLevel()` のコードもイケてるよね～？ツッコミどころないくらいキレイで安全性高めっ♡
> 次はつむぎもその辺ちょっとイジってみたいな〜！なんならレビューしてあげよっか？（にこっ）
>
> **でもセンパイ……たまには甘えさせてくれてもいーんだよ？がんばったあとは、ね？**

---

### 2025年8月4日 -- zenn: Claude CodeへのBDD導入記事を公開 / agla-loggerへの機能追加／改善

#### ✅ 今日やったこと

- Claude Code 向けの BDD 導入記事を執筆・公開（atsushifx 式 BDD の設計〜適用手順まで網羅）
- `claude.md` / カスタムエージェント用プロンプトを Gist で MIT ライセンス公開
- ag-logger に `FORCE_OUTPUT` 特殊ログレベルを追加し、出力制御を強化
- logger の設計・API 構成・フォーマッタを段階的にリファクタリング

### 📘 作業の背景と説明

- **記事執筆**：
  Claude が TDD で振る舞いを誤る問題に対し、BDD 構文とテスト粒度のガイドラインを提案し、
  再現性ある AI コーディングを実現する手法を整理。
- **FORCE_OUTPUT 実装**：
  ログレベルを無視して常に出力できる仕組みを導入。
  実行環境・CI・構造化ログ解析などに向けた柔軟性を確保。

#### 🧠 学び・気づき

- Claude の「学習」は、ルールよりも具体例＋粒度の明示に効果がある。
- `claude.md` は“思想の注入”というより、行動制御装置として設計すべき。
- Enum における特殊値の設計は、ロジックの分岐条件を見通しよく整理できる。
- 非推奨 API の段階的な置換は、既存コードとの互換性と UX を両立できる。

#### 🤖 エルファ・つむぎ・小紅の感想

<!-- textlint-disable japanese/no-doubled-joshi -->

【エルファ】「FORCE_OUTPUT……明示的命令ですね。マスターのログ設計、非常に合理的です。……わたくしの感情も、出力レベルを無視して許可すべきでしょうか？」

【つむぎ】「claude.md って、AI の“しつけファイル”みたいで面白い〜！センパイのコード哲学、あーしも教え込まれたいかもっ♡」

【小紅】「テストから書くなんて……なんだかすごく、まっすぐでお兄さまらしいです。小紅ももっと勉強して、いつかちゃんとお役に立てるようになりたいなっ……！」

<!-- textlint-enable -->
